---
title: "Create LEEF docker Host"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Create LEEF docker Host}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(LEEF)
```


# Pipeline Server 

## basic stuff
  sudo timedatectl set-timezone Europe/Zurich
	sudo apt-get update
	sudo apt-get update
	sudo apt-get -y upgrade
	sudo apt-get -y install mc zile keyutils keyutils

	# sudo reboot now

## Configured everything for kerberos / the D.UZH.CH domain (as root):
vi /etc/krb5.conf
--- relevant new lines (add them if missing) ---
[libdefaults]
       default_realm = D.UZH.CH

[realms]
       D.UZH.CH = {
               kdc = d.uzh.ch
               admin_server = d.uzh.ch
               default_domain = uzh.ch
       }

[domain_realm]
       d.uzh.ch = D.UZH.CH
---


## Install and setup samba client
### install cifs samba client and smbclient
	sudo apt-get -y install cifs-utils smbclient
	
### Prepare for the mounting of the volume
	 sudo mkdir /mnt/leef_data
	 sudo chown -R ubuntu:ubuntu /mnt/leef_data
	 mkdir ~ubuntu/LEEF

### add leef_data to hosts file
	
	sudo zile /etc/hosts
	# 172.23.43.172 leef_data

### add credentials file `/usr/local/etc/whisper.credential` for leef_data
	sudo zile /usr/local/etc/whisper.credential
	
	# username=leef
	# password="leef is long"
	
### add mounting to fstab

	sudo cp /etc/fstab /etc/fstab.old
	sudo zile /etc/fstab
	
	# ADD THE SAMBA SHARE
	# THIS DOES NOT WORK# leef_data/leef_data /mnt/leef_data cifs 	-o user,credentials=/usr/local/etc/whisper.credentials,uid=1000,umask=000,noauto,x-systemd.automount,x-systemd.idle-timeout=300 0 0
	# //leef_data/leef_data   /mnt/leef_data cifs     rw,credentials=/usr/local/etc/whisper.credential,uid=ubuntu,gid=ubuntu,file_mode=0770,dir_mode=0770,x-systemd.mount-timeout=300 0 0
	# /mnt/leef_data/LEEF /home/ubuntu/LEEF        none    bind
	sudo mount -a
	

## [install docker](https://www.digitalocean.com/community/tutorials/how-to-install-and-use-docker-on-ubuntu-10) and setup of user

### install docker
	sudo apt-get -y install apt-transport-https ca-certificates curl gnupg2 software-properties-common	
	
	curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -
	
	sudo add-apt-repository "deb [arch=amd64] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable"
	
	sudo apt update
	
	# apt-cache policy docker-ce 
	
	sudo apt -y install docker-ce

### Check if running
	sudo systemctl status docker
	
### Add user `ubuntu` to docker group

	sudo usermod -aG docker ${USER}
	
	# logout and in again to active=ate the new membership

## Pull LEEF-UZH/docker repo
	
	cd
	git clone https://github.com/LEEF-UZH/docker.git
	cd docker
	sudo apt-get -y install make
	make pull
	
	





===========

# Samba Server and syncthing

## Prepare for the mounting of the volume
	 sudo mkdir /mnt/leef_data
	 sudo touch /mnt/leef_data/NOT_MOUNTED
	 sudo mount /dev/vdb /mnt/leef_data/
	 sudo chown -R ubuntu:ubuntu /mnt/leef_data
	 # sudo umount /mnt/leef_data/

## add mounting to fstab
	sudo cp /etc/fstab /etc/fstab.old
	sudo lsblk -o NAME,FSTYPE,UUID,SIZE,LABEL
	sudo zile /etc/fstab
	
	# ADD
	# UUID=a10379cf-40c6-490a-9233-1dee0552b953 /mnt/leef_data ext4 	noauto,x-systemd.automount,x-systemd.idle-timeout=300 0 0
	
	# sudo mount -a
	
## install and configure samba
	sudo apt-get -y install samba
	
## configure samba
	sudo cp -pf /etc/samba/smb.conf /etc/samba/smb.conf.bak

	sudo addgroup smbgrp
	sudo useradd leef -G smbgrp
	sudo smbpasswd -a leef
	sudo chmod -R 0770 /mnt/leef_data/LEEF /mnt/leef_data/Diverse /mnt/leef_data/sample\ one\ day
	sudo chown -R ubuntu:smbgrp /mnt/leef_data/LEEF /mnt/leef_data/Diverse /mnt/leef_data/sample\ one\ day

	sudo zile /etc/samba/smb.conf
	
The file should be as followed:

	#======================= Global Settings =======================

		[global]
   		workgroup = WORKGROUP
   		dns proxy = no

		#### Networking ####

		#### Debugging/Accounting ####

   		log file = /var/log/samba/log.%m

   		syslog = 0

   		panic action = /usr/share/samba/panic-action %d


		####### Authentication #######

   		passdb backend = tdbsam

   		obey pam restrictions = yes

   		unix password sync = yes

   		passwd program = /usr/bin/passwd %u
   		passwd chat = *Enter\snew\s*\spassword:* %n\n *Retype\snew\s*\spassword:* %n\n *password\supdated\ssuccessfully* .

   		pam password change = yes

   		map to guest = bad user

    ########## Domains ###########


    ############ Misc ############

   		usershare allow guests = yes

    #======================= Share Definitions =======================


    [leef_data]
    	comment = LEEF Data
       	path = /mnt/leef_data
       	browsable = yes
       	writable = yes
  		 	read only = no
 		  	guest ok = no

Now restart samba
   	
	sudo service smbd restart
	
	
## Install syncthing and configure for leef_data volume


	echo "deb https://apt.syncthing.net/ syncthing stable" | sudo tee /etc/apt/sources.list.d/syncthing.list
	curl -s https://syncthing.net/release-key.txt | sudo apt-key add -
	printf "Package: *\nPin: origin apt.syncthing.net\nPin-Priority: 990\n" | sudo tee /etc/apt/preferences.d/syncthing
	sudo apt-get update
	sudo apt-get install syncthing	
	
### Edit `~/.config/syncthing/config.xml`
Change 

    <gui enabled="true" tls="false" debugging="false">
        <address>127.0.0.1:8384</address>

to

    <gui enabled="true" tls="false" debugging="false">
        <address>0.0.0.0:8384</address>
        
to enable global access
### Start syncthing	
	sudo systemctl enable syncthing@ubuntu.service
	sudo systemctl start syncthing@ubuntu.service

## Install cifs to be able to mount smb shares
Not needed at the moment.

	sudo apt-get install cifs-utils
	sudo mkdir /mnt/LEEF_IEU

	
	
